import math
import time

Infinity=math.inf


def mcm(a,b):
    g=math.gcd(a,b)
    return a*b//g

def hexa(x):
    x=hex(x)
    x=x[2:]
    if len(x)%2==1:
        x='0'+x
    return x
    #return hex(x)[2:]

def isprime(n):  # First the primality test
    if n<2:
        return False
    for i in range(2,int(math.sqrt(n))+1):
        if n%i==0:
            return False
            break
    else:
        return True

def nthprime(n):   # then generic code for nth prime number
    x=[]
    j=2
    while len(x)<n:
        if (isprime(j)) == True:
            x.append(j)
        j =j+1
    return x[n-1]

def Mod(a,mod):
    return a%mod

def InvMod(aaa,mod):
    return pow(aaa,-1,mod)

def jacobi(a, n):
#https://www.johndcook.com/blog/2019/02/12/computing-jacobi-symbols/
    assert(n > a > 0 and n%2 == 1)
    t = 1
    while a != 0:
        while a % 2 == 0:
            a /= 2
            r = n % 8
            if r == 3 or r == 5:
                t = -t
            a, n = n, a
        if a % 4 == n % 4 == 3:
            t = -t
            a %= n
        if n == 1:
            return t
        else:
            return 0


def hdprodmod(a,b,h,d,mod):
    if (a==Infinity):
        return b
    elif (b==Infinity):
        return a
    elif (Mod(a+b+h, mod)==0):
        return Infinity
    else:
        return Mod((Mod(d, mod) + Mod(a,mod)*Mod(b,mod)) * InvMod( Mod(h,mod)+Mod(a,mod)+Mod(b,mod),mod),mod)
def hdpotmod(n,h,d,x0,mod): #x0^n mod mod
    z=bin(n)[2:]
    #print(z)
    nbit=len(z)
    v=[0] * nbit
    v[0]=x0
    j=[]
    for i  in range(1,nbit):
        v[i]= hdprodmod(v[i-1],v[i-1],h,d,mod)
        #print("v[",i,"]=",v[i])
    for i in range(0,nbit):
        if (z[nbit-1-i]==str(1)):
            # print(nbit-i)
            j.append(v[i])
    #print(v)
    #print(j)
    
    nbit=len(j)
    ris=j[0]
    for i in range(1,nbit):
        ris =hdprodmod(j[i],ris,h,d,mod)
    return ris 

h=0
start=time.time()
p3=888161167
q3=372281951
n3=p3*q3
d3=55878224492273788
e3=271927297116932759
z3=104929432894710518
ris3=65077473953820362
print("ris3 = ", hdpotmod(e3,0,d3,z3,n3) == ris3,"in",time.time()-start,"secs")

start=time.time()
p2=1217073032281
q2=516867844907
n2=p2*q2
d2=155573345874763183098206
e2=440402925270048815200841
z2=588182170130865887218576
ris2=301909792672242928377467
print("ris2 = ", hdpotmod(e3,0,d3,z3,n3) == ris2,"in",time.time()-start,"secs")

start=time.time()

p3=152655275309794355480090207164060112587082386334652932063316985382132989077903090838651310171110345997633006436261059632279603325336386834843567582119879618354703056762921403561983408384260689235680230737736816142706431973376941366243823198003187216806849398064304209917731518874919544366395499083932955525491
q3=114039228273679263455311356999419186045795855411618476514160729521463856256262156756189609417725694025146919373579684099053305005215303612215955954981777060283674867620829585365043834173619933231119785372088899205686871467698500315625494336030248902701322560790241738901170548673807977499866687023344929382677
n3=p3*q3
d3=4015766715308800894517644062126213464475235677216207577688046379331884890464734614535964156058095899060861868201982792221725571019266742922750233171873827646863501806378165596450422808113929755164022783416852709151440288227613213511507841661411005973434316562011750509872981034658434639065441710238313277691278000568358682653297617618705911931847041044184923528919349669529768933919431026648630021758615815939942503970467112231303391244680901447744160178255887170585812660114668255461954777677985929296608739218564160835840981644807986024807180446294547432215226365173177280188935954722000255280565733907488013017570
e3=6736708895255489082817016242723960877182551373929215809352322188775215700242219615797817567749709292373944990033714967492568970145903666305793928757170567926322518488093357119375317818038198250092819363985182464166549030001170204647284076036636856075865549217830863733759393015341502251692975604439974455555792543989983846580387931708817004207525437342580384153621585649464210749366478115684329388082771924273819526384535963036014514152007684651914268127171552979552185022580146428060519915583249928596500224963586031231714744452886607338440366253573781150877149792191369942956136657390833866374500784961791415308219
z3=13043484225976123998741413796329238303781382678862785492982009356232671575023919354723286625571311910451697865194809907742996492892901243277234826622963299473978740813332404863480403558839453364868475029986677091202308251192311819032386639224597452886331296891413381049541945536636822091622926840134907953961432570319749039614659078692407940087551267508211445779297938548951585249187378511043668104245885493894550789456017574479619200220138667816560178291021066682928320333347196274133518926464979912478943751073784564169375478985425738831733324714460534131076226613391983182724207521420551988409853929371080402579485
ris3=11036504849015527503680392334278365660460798014745445028985958809533076201299510564314662638300512533617173648746807334783697682240661699252844654569949991867463164285081542602150498542991741459376002695894362229875858453831495821735824268143843452496917331825238494730167372889139343603703367524283108895196683922847436284356449916553737211284393344164098779675320401652116842503525398261855438735126040316368224221412821262228780856552390629150649968586052316618625410532293270713034547435975680807219979573060570471444253406140148399789288801890326219053155439980122518093195800081903570540628534191527747412691011
print("ris3 = ", hdpotmod(e3,0,d3,z3,n3) == ris3,"in",time.time()-start,"secs")

start=time.time()